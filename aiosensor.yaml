substitutions:
  name: "aiosensor"  # lowercase only, have to be unique
  friendly_name: "AIOSensor"  # device name and entity prefix
  blegatewayname: "aiosensor"
  version: "1.2.0"
  rgb_led_pin: GPIO3
  uart_rx_pin: GPIO20
  uart_tx_pin: GPIO21
  batt_volt_pin: A1
  bss138_pin: GPIO2 # Gate of BSS138
  voltage_multiplier: "2.0" # Correct if needed
  battery_update_interval: "60s"
  bh1750_update_interval: "5s"
  illuminance_offset: "0"
  bme_address: "0x77"  # for some modules you have to change it to 0x77
  bme_update_interval: 30s
  co2_offset: "0"  # bsec only
  humidity_offset: "0.0"
  iaq_offset: "0" # bsec only
  pressure_offset: "0"
  temperature_offset: "0.0"
  voc_offset: "0" # bsec only

esphome:
  name: "${name}"
  comment: BLEProxy LD2410b BH1750 BME680
  friendly_name: "${friendly_name}"
  name_add_mac_suffix: False
  project:
    name: "dincojazz.AIOsensor"
    version: "${version}"
  platformio_options:
    board_build.extra_flags:
      - "-DARDUINO_USB_CDC_ON_BOOT=0"
    board_build.flash_mode: dio
  min_version: 2023.10.0

dashboard_import:
  package_import_url: github://dincojazz/AIOSensor/aiosensor.yaml@main
  import_full_config: true

esp32:
  board: lolin_c3_mini
  variant: ESP32C3
  framework:
    type: esp-idf

external_components:
  - source:
      type: local
      path: my_custom_components

globals:
  - id: last_update_ld2450
    type: unsigned long
    restore_value: no
    initial_value: '0'
  - id: init_zone_publish
    type: bool
    restore_value: no
    initial_value: "false"
  - id: last_illuminance
    type: float
    restore_value: no
    initial_value: "-1"

# Enable Home Assistant API
api:
  encryption:
    key: "dwShqGuNTqBy2jBYng0R8TY76tD+CBJZTXNZjUMNli8="

ota:
  - platform: esphome
    password: "326fc6ca927782acec4e0007007b0dfc"

safe_mode:
  disabled: false

logger:
#  baud_rate: 0  # disable logging via UART

debug:
  update_interval: 30s

i2c:
  sda: GPIO8
  scl: GPIO9
  scan: true
  id: bus_a

uart:
  tx_pin: "${uart_tx_pin}"
  rx_pin: "${uart_rx_pin}"
  baud_rate: 256000
  parity: NONE
  stop_bits: 1
  data_bits: 8

time:
  - platform: sntp
    id: time_now

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  fast_connect: false
  #power_save_mode: LIGHT #HIGH
  # Fallback hotspot (captive portal) in case wifi connection fails
  ap:
    ssid: "${friendly_name}FallbackAP"
    password: !secret web_server_password
  output_power: 12.5dBm

captive_portal:

#web_server:
#  port: 80
#  auth:
#    username: !secret web_server_user
#    password: !secret web_server_password

esp32_ble_tracker:
  scan_parameters:
    active: true

bluetooth_proxy:
  active: true

#esp32_improv:
#  authorizer: none

ble_gateway:
  id: ${blegatewayname}_blegateway
  devices:
    - mac_address: !secret mi_scale_v2_mac
  on_ble_advertise:
    then:
      homeassistant.event:
        event: esphome.on_ble_advertise
        data:
          packet: !lambda return packet;
          gateway_id: "$(ble_gateway_id)"

light:
#  - platform: status_led
#    name: ESP32C_Status
#    pin:
#      number: GPIO8
#      inverted: True
#    internal: False
#    restore_mode: ALWAYS_OFF
  
  - platform: esp32_rmt_led_strip
    rgb_order: GRB
    pin: GPIO3
    num_leds: 7
    chipset: WS2812
    name: "Air Quality Index LED"
    id: ws2812_7led
    restore_mode: RESTORE_AND_OFF
    use_psram: False
    effects:
      - automation:
          name: Dial Effect
          sequence:
            - light.addressable_set:
                id: ws2812_7led
                red: 0
                green: 0
                blue: 0
            - light.addressable_set:
                id: ws2812_7led7
                red:   0
                green: 1
                blue:  0
            - delay: 0.2s
            - light.addressable_set:
                id: ws2812_7led6
                red:   0
                green: 1
                blue:  0
            - light.addressable_set:
                id: ws2812_7led7
                red:   0
                green: 1
                blue:  0
            - delay: 0.2s
            - light.addressable_set:
                id: ws2812_7led5
                red: 0.98
                green: 0.91
                blue: 0.13
            - light.addressable_set:
                id: ws2812_7led7
                red: 0.98
                green: 0.91
                blue: 0.13
            - delay: 0.2s
            - light.addressable_set:
                id: ws2812_7led4
                red: 1
                green: 0.549
                blue: 0
            - light.addressable_set:
                id: ws2812_7led7
                red: 1
                green: 0.549
                blue: 0
            - delay: 0.2s
            - light.addressable_set:
                id: ws2812_7led3
                red:   1
                green: 0
                blue:  0
            - light.addressable_set:
                id: ws2812_7led7
                red:   1
                green: 0
                blue:  0
            - delay: 0.2s
            - light.addressable_set:
                id: ws2812_7led2
                red:   0.5
                green: 0
                blue:  0.5
            - light.addressable_set:
                id: ws2812_7led7
                red:   0.5
                green: 0
                blue:  0.5
            - delay: 0.2s
            - light.addressable_set:
                id: ws2812_7led1
                red:   0.502
                green: 0
                blue:  0
            - light.addressable_set:
                id: ws2812_7led7
                red:   0.502
                green: 0
                blue:  0
            - delay: 0.2s
            - light.addressable_set:
                id: ws2812_7led
                red: 0
                green: 0
                blue: 0
      - automation:
          name: 5 LED Dial
          sequence:
            - light.addressable_set:
                id: ws2812_7led6
                color_brightness: 30%
                red:   0
                green: 1
                blue:  0
            - light.addressable_set:
                id: ws2812_7led5
                color_brightness: 30%
                red: 0.98
                green: 0.91
                blue: 0.13
            - light.addressable_set:
                id: ws2812_7led4
                color_brightness: 30%
                red: 1
                green: 0.549
                blue: 0
            - light.addressable_set:
                id: ws2812_7led3
                color_brightness: 30%
                red:   1
                green: 0
                blue:  0
            - light.addressable_set:
                id: ws2812_7led2
                color_brightness: 30%
                red:   0.5
                green: 0
                blue:  0.5
            - light.addressable_set:
                id: ws2812_7led1
                red:   0
                green: 0
                blue:  0

      - pulse:
          name: "Fast Pulse"
          transition_length: 0.5s
          update_interval: 0.5s
          min_brightness: 0%
          max_brightness: 100%
      - pulse:
          name: "Slow Pulse"
          transition_length: 500ms
          update_interval: 2s
      - pulse:
          name: "Slow Pulse 30%"
          transition_length: 500ms
          update_interval: 2s
          min_brightness: 0%
          max_brightness: 30%
      - addressable_rainbow: 
          name: Rainbow
          speed: 10
          width: 50
  - platform: partition
    name: "AQI LED_1"
    id: ws2812_7led1
    segments: 
      - id: ws2812_7led
        from: 0
        to: 0
    effects:
      - pulse:
          name: "Fast Pulse"
          transition_length: 0.5s
          update_interval: 0.5s
          min_brightness: 0%
          max_brightness: 100%
      - pulse:
          name: "Slow Pulse"
          transition_length: 500ms
          update_interval: 2s
      - pulse:
          name: "Slow Pulse 30%"
          transition_length: 500ms
          update_interval: 2s
          min_brightness: 0%
          max_brightness: 30%
  - platform: partition
    name: "AQI LED_2"
    id: ws2812_7led2
    segments: 
      - id: ws2812_7led
        from: 1
        to: 1
    effects:
      - pulse:
          name: "Fast Pulse"
          transition_length: 0.5s
          update_interval: 0.5s
          min_brightness: 0%
          max_brightness: 100%
      - pulse:
          name: "Slow Pulse"
          transition_length: 500ms
          update_interval: 2s
      - pulse:
          name: "Slow Pulse 30%"
          transition_length: 500ms
          update_interval: 2s
          min_brightness: 0%
          max_brightness: 30%
  - platform: partition
    name: "AQI LED_3"
    id: ws2812_7led3
    segments: 
      - id: ws2812_7led
        from: 2
        to: 2
    effects:
      - pulse:
          name: "Fast Pulse"
          transition_length: 0.5s
          update_interval: 0.5s
          min_brightness: 0%
          max_brightness: 100%
      - pulse:
          name: "Slow Pulse"
          transition_length: 500ms
          update_interval: 2s
      - pulse:
          name: "Slow Pulse 30%"
          transition_length: 500ms
          update_interval: 2s
          min_brightness: 0%
          max_brightness: 30%
  - platform: partition
    name: "AQI LED_4"
    id: ws2812_7led4
    segments: 
      - id: ws2812_7led
        from: 3
        to: 3
    effects:
      - pulse:
          name: "Fast Pulse"
          transition_length: 0.5s
          update_interval: 0.5s
          min_brightness: 0%
          max_brightness: 100%
      - pulse:
          name: "Slow Pulse"
          transition_length: 500ms
          update_interval: 2s
      - pulse:
          name: "Slow Pulse 30%"
          transition_length: 500ms
          update_interval: 2s
          min_brightness: 0%
          max_brightness: 30%
  - platform: partition
    name: "AQI LED_5"
    id: ws2812_7led5
    segments: 
      - id: ws2812_7led
        from: 4
        to: 4
    effects:
      - pulse:
          name: "Fast Pulse"
          transition_length: 0.5s
          update_interval: 0.5s
          min_brightness: 0%
          max_brightness: 100%
      - pulse:
          name: "Slow Pulse"
          transition_length: 500ms
          update_interval: 2s
      - pulse:
          name: "Slow Pulse 30%"
          transition_length: 500ms
          update_interval: 2s
          min_brightness: 0%
          max_brightness: 30%
  - platform: partition
    name: "AQI LED_6"
    id: ws2812_7led6
    segments: 
      - id: ws2812_7led
        from: 5
        to: 5
    effects:
      - pulse:
          name: "Fast Pulse"
          transition_length: 0.5s
          update_interval: 0.5s
          min_brightness: 0%
          max_brightness: 100%
      - pulse:
          name: "Slow Pulse"
          transition_length: 500ms
          update_interval: 2s
      - pulse:
          name: "Slow Pulse 30%"
          transition_length: 500ms
          update_interval: 2s
          min_brightness: 0%
          max_brightness: 30%
  - platform: partition
    name: "AQI LED_7"
    id: ws2812_7led7
    segments: 
      - id: ws2812_7led
        from: 6
        to: 6
    effects:
      - pulse:
          name: "Fast Pulse"
          transition_length: 0.5s
          update_interval: 0.5s
          min_brightness: 0%
          max_brightness: 100%
      - pulse:
          name: "Slow Pulse"
          transition_length: 500ms
          update_interval: 2s
      - pulse:
          name: "Slow Pulse 30%"
          transition_length: 500ms
          update_interval: 2s
          min_brightness: 0%
          max_brightness: 30%

bme68x_bsec2_i2c:
  address: "${bme_address}"
  model: bme680
  operating_age: 4d
  sample_rate: LP
  supply_voltage: 3.3V
  #temperature_offset: "${temperature_offset}"

ld2410:

button:
  - platform: restart
    icon: mdi:power-cycle
    name: "ESP Reboot"
    entity_category: diagnostic
  - platform: safe_mode
    name: "Restart (Safe Mode)"
    entity_category: diagnostic
  - platform: ld2410
    factory_reset:
      name: "mmWave Factory Reset"
    restart:
      name: "mmWave Restart"
    query_params:
      name: "mmWave Force Refresh"
  - platform: template
    name: "Script stop"
    id: aqi_led_control_script_stop
    on_press: 
      then:
        - script.stop: AQI_LED_control
        - light.turn_off: ws2812_7led
        - light.turn_off: ws2812_7led7
  - platform: template
    name: "Script start"
    id: aqi_led_control_script_start
    on_press: 
      then:
        - script.execute: AQI_LED_control
  - platform: template
    name: "Update Battery Now"
    id: update_battery_btn
    icon: "mdi:gesture-tap-button"
    on_press:
      then:
        - script.execute: take_battery_measurement
switch:
  - platform: ld2410
    engineering_mode:
      name: "mmWave Engineering Mode"
    bluetooth:
      name: "mmWave Bluetooth"
  - platform: template
    id: switch_ble_gateway_discovery
    name: "BLE Gateway Discovery"
    icon: mdi:bluetooth-connect
    lambda: return id(${blegatewayname}_blegateway).get_discovery();
    turn_on_action:
      lambda: 
        id(${blegatewayname}_blegateway).set_discovery(true);
    turn_off_action:
      lambda: 
        id(${blegatewayname}_blegateway).set_discovery(false);
    disabled_by_default: false
    entity_category: config
  - platform: gpio
    name: "Battery divider switch"
    pin: "${bss138_pin}"
    id: batt_divider_switch
    restore_mode: ALWAYS_OFF
    internal: false
  - platform: factory_reset
    name: "ESP Factory Reset"
    disabled_by_default: True
    icon: mdi:heart-broken

select:
  - platform: ld2410
    distance_resolution:
      name: "mmWave Distance Resolution"
    baud_rate:
      name: "mmWave Baud Rate"
    light_function:
      name: "mmWave Light Function"
    out_pin_level:
      name: "mmWave Out Pin Level"

binary_sensor:
  - platform: status
    name: "Status"
    id: link_ha_connected
  - platform: template
    name: "Occupancy"
    id: occupancy
    device_class: occupancy
    lambda: |-
      if (id(motion_mmwave).state) {
        return true;
      }
      else if (id(motion_mmwave).state == 0 ) {
        return false;
      }
      else {
        return id(occupancy).state;
      }
  - platform: homeassistant
    name: "BLE Gateway Discovery"
    id: ble_gateway_discovery
    entity_id: binary_sensor.ble_gateway
    attribute: discovery
    on_state:
      then:
        lambda: id(${blegatewayname}_blegateway).set_discovery(x);
  - platform: ld2410
    has_target:
      name: "mmWave"
      id: motion_mmwave
      on_press: 
        then:
          - script.execute: AQI_LED_control
      on_release: 
        then:
          - script.stop: AQI_LED_control
          - light.turn_off: ws2812_7led
          - light.turn_off: ws2812_7led7
    has_moving_target:
      name: "mmWave Moving Target"
    has_still_target:
      name: "mmWave Still Target"
    out_pin_presence_status:
      name: "mmWave out pin presence status"
  - platform: gpio
    pin: GPIO0 #A0
    name: "GPIO Out pin presence"
    device_class: presence

sensor:
  - platform: wifi_signal
    name: "Wifi Signal"
    id: wifi_signal_db
    update_interval: 60s
    entity_category: "diagnostic"
  - platform: debug
    cpu_frequency:
      icon: mdi:cpu-32-bit
      id: cpu_speed
      name: "CPU Frequency"
      filters:
        - lambda: return x / 1000000;
      unit_of_measurement: "MHz"
      entity_category: "diagnostic"
  - platform: internal_temperature
    name: "CPU Temperature"
  - platform: template
    id: esp_memory
    icon: mdi:memory
    name: "ESP Free Memory"
    lambda: return heap_caps_get_free_size(MALLOC_CAP_INTERNAL) / 1024;
    unit_of_measurement: 'kB'
    state_class: measurement
    entity_category: "diagnostic"
    update_interval: 60s
  - platform: uptime
    name: "ESP Uptime"
    id: sys_uptime
    update_interval: 60s
    entity_category: "diagnostic"
  - platform: bh1750
    id: illuminance_sensor
    name: "Illuminance"
    address: 0x23
    update_interval: "${bh1750_update_interval}"
    filters:
      - offset: ${illuminance_offset}
      - lambda: "return x + id(illuminance_offset_ui).state;"
  - platform: bme68x_bsec2
    temperature:
      name: "Temperature"
      accuracy_decimals: 2
      filters:
        - offset: ${temperature_offset}
        - lambda: "return x + id(temperature_offset_ui).state;"
    pressure:
      name: "Pressure"
      device_class: atmospheric_pressure
      filters:
        - offset: ${pressure_offset}
        - lambda: "return x + id(pressure_offset_ui).state;"
    humidity:
      name: "Humidity"
      accuracy_decimals: 2
      filters:
        - offset: ${humidity_offset}
        - lambda: "return x + id(humidity_offset_ui).state;"
    gas_resistance:
      name: "Gas Resistance"
      id: gasresistance
      filters:
        - median
    iaq_static:
      name: "IAQ Static"
      id: iaqstatic
      device_class: aqi
      filters:
        - offset: ${iaq_offset}
        - lambda: "return x + id(iaq_offset_ui).state;"
    iaq_accuracy:
      name: "IAQ Accuracy"
      id: iaqaccuracy
    co2_equivalent:
      name: "CO2 Equivalent"
      device_class: carbon_dioxide
      filters:
        - offset: ${co2_offset}
        - lambda: "return x + id(co2_offset_ui).state;"
    breath_voc_equivalent:
      name: "Breath VOC Equivalent"
      device_class: volatile_organic_compounds_parts
      filters:
        - offset: ${voc_offset}
        - lambda: "return x + id(voc_offset_ui).state;"
  - platform: ld2410
    light:
      name: light
    moving_distance:
      name: "mmWave Moving Distance"
    still_distance:
      name: "mmWave Still Distance"
    moving_energy:
      name: "mmWave Move Energy"
    still_energy:
      name: "mmWave Still Energy"
    detection_distance:
      name: "mmWave Detection Distance"
    g0:
      move_energy:
        name: "mmWave g0 move energy"
      still_energy:
        name: "mmWave g0 still energy"
    g1:
      move_energy:
        name: "mmWave g1 move energy"
      still_energy:
        name: "mmWave g1 still energy"
    g2:
      move_energy:
        name: "mmWave g2 move energy"
      still_energy:
        name: "mmWave g2 still energy"
    g3:
      move_energy:
        name: "mmWave g3 move energy"
      still_energy:
        name: "mmWave g3 still energy"
    g4:
      move_energy:
        name: "mmWave g4 move energy"
      still_energy:
        name: "mmWave g4 still energy"
    g5:
      move_energy:
        name: "mmWave g5 move energy"
      still_energy:
        name: "mmWave g5 still energy"
    g6:
      move_energy:
        name: "mmWave g6 move energy"
      still_energy:
        name: "mmWave g6 still energy"
    g7:
      move_energy:
        name: "mmWave g7 move energy"
      still_energy:
        name: "mmWave g7 still energy"
    g8:
      move_energy:
        name: "mmWave g8 move energy"
      still_energy:
        name: "mmWave g8 still energy"
  - platform: adc
    pin: "${batt_volt_pin}" # Voltage Divider Output
    id: raw_adc_voltage
    name: "Battery Voltage Raw"
    internal: true
    update_interval: never #60s - Takes a reading every minute
    attenuation: 12db # Range up to ~3.3V
    accuracy_decimals: 3
    filters:
      - multiply: ${voltage_multiplier}
  - platform: template
    name: "Battery Voltage"
    id: battery_voltage
    unit_of_measurement: "V"
    device_class: "voltage"
    state_class: "measurement"
    accuracy_decimals: 2
    update_interval: ${battery_update_interval}
    on_value_range:
      - below: 3.3
        then:
          - homeassistant.service:
              service: notify.notify
              data:
                title: "Critical battery: ${friendly_name}"
                message: "Voltage falls under 3.3V!"
                priority: "high"
    lambda: "return id(raw_adc_voltage).state;"
    on_value:
      then:
        - if:
            condition:
              # Measuring only if ESP32 is connected to Home Assistant
              binary_sensor.is_on: link_ha_connected
            then:
              - switch.turn_on: batt_divider_switch
              - delay: 500ms # Important for charge condensator 100nF trough 2.2MΩ
              - component.update: raw_adc_voltage
              - switch.turn_off: batt_divider_switch
            else:
              - logger.log: "HA is disconnected - measuring dissmissed."
  - platform: copy
    source_id: battery_voltage
    name: "Battery Charge Percent"
    id: battery_percent
    unit_of_measurement: "%"
    device_class: "battery"
    accuracy_decimals: 0
    filters:
      - calibrate_linear:
          - 4.2 -> 100
          - 4.0 -> 80
          - 3.8 -> 60
          - 3.7 -> 40
          - 3.5 -> 10
          - 3.3 -> 0
      - clamp:
          min_value: 0
          max_value: 100

number:
  - platform: template
    name: "Offset Illuminance"
    id: illuminance_offset_ui
    unit_of_measurement: "lx"
    min_value: -100
    max_value: 100
    step: 1
    mode: box
    update_interval: never
    optimistic: true
    restore_value: true
    initial_value: 0
    icon: "mdi:brightness-5"
    entity_category: config
    on_value:
      - lambda: 'id(illuminance_sensor).update();'
  - platform: template
    name: "Offset Temperature"
    id: temperature_offset_ui
    unit_of_measurement: "°C"
    min_value: -25
    max_value: 25
    step: 0.01
    mode: box
    update_interval: never
    optimistic: true
    restore_value: true
    initial_value: 0 #${temperature_offset}
    icon: "mdi:thermometer"
    entity_category: config
  - platform: template
    name: "Offset Humidity"
    id: humidity_offset_ui
    unit_of_measurement: "%"
    min_value: -50
    max_value: 50
    step: 0.01
    mode: box
    update_interval: never
    optimistic: true
    restore_value: true
    initial_value: ${humidity_offset}
    icon: "mdi:water-percent"
    entity_category: config
  - platform: template
    name: "Offset Pressure"
    id: pressure_offset_ui
    unit_of_measurement: "hPa"
    min_value: -500
    max_value: 500
    step: 1
    mode: box
    update_interval: never
    optimistic: true
    restore_value: true
    initial_value: 0
    icon: "mdi:gauge"
    entity_category: config
  - platform: template
    name: "Offset CO2"
    id: co2_offset_ui
    unit_of_measurement: "ppm"
    min_value: -1000
    max_value: 1000
    step: 1
    mode: box
    update_interval: never
    optimistic: true
    restore_value: true
    initial_value: 0
    icon: "mdi:test-tube"
    entity_category: config
  - platform: template
    name: "Offset VOC"
    id: voc_offset_ui
    unit_of_measurement: "ppm"
    min_value: -1000
    max_value: 1000
    step: 1
    mode: box
    update_interval: never
    optimistic: true
    restore_value: true
    initial_value: 0
    icon: "mdi:test-tube"
    entity_category: config
  - platform: template
    name: "Offset IAQ"
    id: iaq_offset_ui
    unit_of_measurement: "IAQ"
    min_value: -400
    max_value: 400
    step: 1
    mode: box
    update_interval: never
    optimistic: true
    restore_value: true
    initial_value: 0
    icon: "mdi:gauge"
    entity_category: config
  - platform: ld2410
    timeout:
      name: "mmWave Timeout"
    light_threshold:
      name: "mmWave Light Threshold"
    max_move_distance_gate:
      name: "mmWave Max Move Distance Gate"
    max_still_distance_gate:
      name: "mmWave Max Still Distance Gate"
    g0:
      move_threshold:
        name: "mmWave g0 move threshold"
      still_threshold:
        name: "mmWave g0 still threshold"
    g1:
      move_threshold:
        name: "mmWave g1 move threshold"
      still_threshold:
        name: "mmWave g1 still threshold"
    g2:
      move_threshold:
        name: "mmWave g2 move threshold"
      still_threshold:
        name: "mmWave g2 still threshold"
    g3:
      move_threshold:
        name: "mmWave g3 move threshold"
      still_threshold:
        name: "mmWave g3 still threshold"
    g4:
      move_threshold:
        name: "mmWave g4 move threshold"
      still_threshold:
        name: "mmWave g4 still threshold"
    g5:
      move_threshold:
        name: "mmWave g5 move threshold"
      still_threshold:
        name: "mmWave g5 still threshold"
    g6:
      move_threshold:
        name: "mmWave g6 move threshold"
      still_threshold:
        name: "mmWave g6 still threshold"
    g7:
      move_threshold:
        name: "mmWave g7 move threshold"
      still_threshold:
        name: "mmWave g7 still threshold"
    g8:
      move_threshold:
        name: "mmWave g8 move threshold"
      still_threshold:
        name: "mmWave g8 still threshold"

text_sensor:
  - platform: ble_scanner
    name: "BLE Devices Scanner"
  - platform: bme68x_bsec2
    iaq_accuracy:
      name: "IAQ Accuracy"
      icon: mdi:checkbox-marked-circle-outline
      id: iaq_accuracy
  - platform: template
    name: "IAQ Classification"
    icon: "mdi:checkbox-marked-circle-outline"
    lambda: |-
      if ( int(id(iaqstatic).state) <= 50) {
        return {"Excellent"};
      }
      else if (int(id(iaqstatic).state) >= 51 && int(id(iaqstatic).state) <= 100) {
        return {"Good"};
      }
      else if (int(id(iaqstatic).state) >= 101 && int(id(iaqstatic).state) <= 150) {
        return {"Lightly polluted"};
      }
      else if (int(id(iaqstatic).state) >= 151 && int(id(iaqstatic).state) <= 200) {
        return {"Moderately polluted"};
      }
      else if (int(id(iaqstatic).state) >= 201 && int(id(iaqstatic).state) <= 250) {
        return {"Heavily polluted"};
      }
      else if (int(id(iaqstatic).state) >= 251 && int(id(iaqstatic).state) <= 350) {
        return {"Severely polluted"};
      }
      else if (int(id(iaqstatic).state) >= 351) {
        return {"Extremely polluted"};
      }
      else {
        return {"error"};
      }
  - platform: ld2410
    version:
      name: "mmWave Firmware Version"
    mac_address:
      name: "mmWave Mac Address"
  - platform: homeassistant
    id: ble_gateway_devices
    entity_id: binary_sensor.ble_gateway
    attribute: devices
    on_value:
      then:
        lambda: id(${blegatewayname}_blegateway).set_devices(x);
  - platform: debug
    reset_reason:
      name: "ESP Reset Reason"
      icon: mdi:anchor
      disabled_by_default: False
  - platform: wifi_info
    ip_address:
      name: "ESP IP Address"
      entity_category: "diagnostic"
      disabled_by_default: True
      icon: mdi:ip-network
    mac_address:
      name: "ESP MAC"
      entity_category: "diagnostic"
      icon: mdi:ip-network
      disabled_by_default: True

script:
  - id: AQI_LED_control
    mode: single
    then:
      - if:
          condition:
            - lambda: return id(iaqstatic).state < 50;
          then:
            - light.turn_on:
                id: ws2812_7led
                effect: 5 LED Dial
            - light.turn_on:
                id: ws2812_7led7
                effect: Slow Pulse 30%
                brightness: !lambda |-
                  return ((id(illuminance_sensor).state / 100) + 0.1);
                red:   0
                green: 1
                blue:  0
      - if:
          condition:
            - lambda: return id(iaqstatic).state >= 51 & id(iaqstatic).state < 100;
          then:
            - light.turn_on:
                id: ws2812_7led
                effect: 5 LED Dial
            - light.turn_on:
                id: ws2812_7led7
                effect: Slow Pulse 30%
                brightness: !lambda |-
                  return ((id(illuminance_sensor).state / 100) + 0.1);
                red: 1
                green: 1
                blue: 0
      - if:
          condition:
            - lambda: return id(iaqstatic).state >= 101 & id(iaqstatic).state < 150;
          then:
            - light.turn_on:
                id: ws2812_7led
                effect: 5 LED Dial
            - light.turn_on:
                id: ws2812_7led7
                effect: Slow Pulse 30%
                brightness: !lambda |-
                  return ((id(illuminance_sensor).state / 100) + 0.1);
                red: 1
                green: 0.65
                blue: 0
      - if:
          condition:
            - lambda: return id(iaqstatic).state >= 151 & id(iaqstatic).state < 200;
          then:
            - light.turn_on:
                id: ws2812_7led
                effect: 5 LED Dial
            - light.turn_on:
                id: ws2812_7led7
                effect: Slow Pulse 30%
                brightness: !lambda |-
                  return ((id(illuminance_sensor).state / 100) + 0.1);
                red: 1
                green: 0
                blue: 0
      - if:
          condition:
            - lambda: return id(iaqstatic).state >= 201 & id(iaqstatic).state < 300;
          then:
            - light.turn_on:
                id: ws2812_7led
                effect: 5 LED Dial
            - light.turn_on:
                id: ws2812_7led7
                effect: Slow Pulse 30%
                brightness: !lambda |-
                  return ((id(illuminance_sensor).state / 100) + 0.1);
                red: 0.5
                green: 0
                blue: 0.5
      - if:
          condition:
            - lambda: return id(iaqstatic).state >= 301;
          then:
            - light.turn_on:
                id: ws2812_7led
                effect: 5 LED Dial
            - light.turn_on:
                id: ws2812_7led7
                effect: Slow Pulse 30%
                brightness: !lambda |-
                  return ((id(illuminance_sensor).state / 100) + 0.1);
                red: 0.502
                green: 0
                blue: 0

  - id: take_battery_measurement
    mode: restart
    then:
      - switch.turn_on: batt_divider_switch
      - delay: 500ms # Critical for charge condensator 100nF trough 2.2MΩ
      - component.update: raw_adc_voltage
      - component.update: battery_voltage
      - switch.turn_off: batt_divider_switch
      - logger.log: "Battery measurement is successful."
